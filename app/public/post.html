<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Lease</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <link rel="stylesheet" href="style/navbar.css">
    <link rel="stylesheet" href="style/styles.css">
    <link rel="stylesheet" href="style/post.css">

</head>

<body>
    <!-- Navbar Placeholder -->
    <div id="navbar-placeholder"></div>

    <div id="post-content-container" class="content-container">
        <h4 class="text-center"><i class="fa fa-building"></i> Property Details</h4> <!-- Added icon for section title -->
        <form id="lease-form">
            <div class="row mb-3">
                <div class="col-md-12">
                    <label for="title" class="form-label">
                        <i class="fa fa-home"></i> Listing Title
                    </label>
                    <input type="text" id="title" class="form-control" placeholder="Student Housing on 32nd and Spring Garden" required>
                </div>
            </div>
    
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="address" class="form-label">
                        <i class="fa fa-map-marker-alt"></i> Street Address
                    </label>
                    <input type="text" id="address" class="form-control" required>
                </div>
                <div class="col-md-6">
                    <label for="city" class="form-label">
                        <i class="fa fa-city"></i> City
                    </label>
                    <input type="text" id="city" class="form-control" required>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="state" class="form-label">
                        <i class="fa fa-landmark"></i> State
                    </label>
                    <input type="text" id="state" class="form-control" required>
                </div>
                <div class="col-md-4">
                    <label for="zip" class="form-label">
                        <i class="fa fa-envelope"></i> Zip Code
                    </label>
                    <input type="text" id="zip" class="form-control" required>
                </div>
                <div class="col-md-4">
                    <label for="rent-price" class="form-label">
                        <i class="fa fa-money-bill-wave"></i> Rent per month ($)
                    </label>
                    <input type="number" id="rent-price" class="form-control" required>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="start-date" class="form-label">
                        <i class="fa fa-calendar"></i> Start Date
                    </label>
                    <input type="date" id="start-date" class="form-control" required>
                </div>
                <div class="col-md-6">
                    <label for="end-date" class="form-label">
                        <i class="fa fa-calendar"></i> End Date 
                    </label>
                    <input type="date" id="end-date" class="form-control" required>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="bedrooms" class="form-label">
                        <i class="fa fa-bed"></i> Number of Bedrooms
                    </label>
                    <input type="number" id="bedrooms" class="form-control" required>
                </div>
                <div class="col-md-6">
                    <label for="bathrooms" class="form-label">
                        <i class="fa fa-bath"></i> Number of Bathrooms
                    </label>
                    <input type="number" id="bathrooms" class="form-control" required>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="property-type" class="form-label">
                        <i class="fa fa-building"></i> Property Type
                    </label>
                    <select id="property-type" class="form-select" required>
                        <option value="" disabled selected>Select</option>
                        <option value="apartment">Apartment</option>
                        <option value="house">House</option>
                        <option value="student-housing">Student Housing</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="shared-space" class="form-label">
                        <i class="fa fa-users"></i> Shared Space?
                    </label>
                    <select id="shared-space" class="form-select" required>
                        <option value="" disabled selected>Select</option>
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </select>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="furnished" class="form-label">
                        <i class="fa fa-couch"></i> Furnished?
                    </label>
                    <select id="furnished" class="form-select" required>
                        <option value="" disabled selected>Select</option>
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="bathroom-type" class="form-label">
                        <i class="fa fa-bath"></i> Private or Shared Bathroom?
                    </label>
                    <select id="bathroom-type" class="form-select" required>
                        <option value="" disabled selected>Select</option>
                        <option value="private">Private</option>
                        <option value="shared">Shared</option>
                    </select>
                </div>
            </div>

            <!-- Amenities -->
            <h4 class="text-center">Amenities</h4>
            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="gym">
                        <label class="form-check-label" for="gym">Gym</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="pool">
                        <label class="form-check-label" for="pool">Pool</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="washer-dryer">
                        <label class="form-check-label" for="washer-dryer">Washer/Dryer</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="dishwasher">
                        <label class="form-check-label" for="dishwasher">Dishwasher</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="tv">
                        <label class="form-check-label" for="tv">TV</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="full-kitchen">
                        <label class="form-check-label" for="full-kitchen">Full Kitchen</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="pet-friendly">
                        <label class="form-check-label" for="pet-friendly">Pet Friendly</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="free-parking">
                        <label class="form-check-label" for="free-parking">Free Parking</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="paid-parking">
                        <label class="form-check-label" for="paid-parking">Paid Parking</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="remote-lock">
                        <label class="form-check-label" for="remote-lock">Remote Lock</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="handicapped-access">
                        <label class="form-check-label" for="handicapped-access">Handicapped Access</label>
                    </div>
                </div>
            </div>

            <!-- Image Upload -->
            <h4 class="text-center">Upload Images</h4>
            <div class="row mb-3">
                <div class="col-md-12">
                    <input type="file" id="image-upload" class="form-control d-none" accept="image/*" multiple>
                    <button type="button" id="custom-upload-button" class="btn btn-secondary">Add Images</button>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-12">
                    <div id="drop-area" class="drop-area">
                        Drag & Drop Images Here or Click "Add Images"
                    </div>
                    <div id="image-preview-container" class="d-flex flex-wrap mt-3"></div>
                </div>
            </div>

            <!-- Contact Information -->
            <h4 class="text-center">Contact Information</h4>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="phone" class="form-label">
                        <i class="fa fa-phone"></i> Phone Number
                    </label>
                    <input type="tel" id="phone" class="form-control" required>
                </div>
                <div class="col-md-6">
                    <label for="email" class="form-label">
                        <i class="fa fa-envelope"></i> Email Address
                    </label>
                    <input type="email" id="email" class="form-control" required>
                </div>
            </div>
    
            <!-- Additional Comments -->
            <h4 class="text-center">Additional Comments</h4>
            <div class="row mb-3">
                <div class="col-md-12">
                    <textarea id="comments" class="form-control" rows="4" placeholder="Enter extra details..."></textarea>
                </div>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn btn-primary w-100">Submit Lease</button>
        </form>
    </div>

    <!-- Footer -->
    <footer class="footer mt-5">
        <p>&copy; 2025 Your Company. All rights reserved.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function validateInput(input, condition) {
            if (condition) {
                input.style.border = "2px solid green";
            } else {
                input.style.border = "2px solid red";
            }
        }

        // Title validation
        document.getElementById("title").addEventListener("input", function () {
            validateInput(this, this.value.trim().length > 0);
        });

        // Address validation
        document.getElementById("address").addEventListener("input", function () {
            validateInput(this, this.value.length >= 5);
        });

        // City & State validation (only letters)
        document.getElementById("city").addEventListener("input", function () {
            validateInput(this, /^[A-Za-z\s]+$/.test(this.value));
        });

        document.getElementById("state").addEventListener("input", function () {
            validateInput(this, /^[A-Za-z\s]+$/.test(this.value));
        });

        // Zip code validation (must be exactly 5 numbers)
        document.getElementById("zip").addEventListener("input", function () {
            validateInput(this, /^\d{5}$/.test(this.value));
        });

        // Date validation (Start date must be before end date)
        function validateDates() {
            const startDateInput = document.getElementById("start-date");
            const endDateInput = document.getElementById("end-date");

            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);

            if (!isNaN(startDate.getTime()) && !isNaN(endDate.getTime())) {
                if (startDate <= endDate) {
                    validateInput(startDateInput, true);
                    validateInput(endDateInput, true);
                } else {
                    validateInput(startDateInput, false);
                    validateInput(endDateInput, false);
                }
            } else {
                validateInput(startDateInput, !isNaN(startDate.getTime()));
                validateInput(endDateInput, !isNaN(endDate.getTime()));
            }
        }

        document.getElementById("start-date").addEventListener("input", validateDates);
        document.getElementById("end-date").addEventListener("input", validateDates);

        // Property details validation
        document.getElementById("rent-price").addEventListener("input", function () {
            validateInput(this, this.value >= 0);
        });

        document.getElementById("bedrooms").addEventListener("input", function () {
            validateInput(this, this.value > 0);
        });

        document.getElementById("bathrooms").addEventListener("input", function () {
            validateInput(this, this.value > 0);
        });

        // Phone number validation (format: 123-456-7890)
        document.getElementById("phone").addEventListener("input", function () {
            validateInput(this, /^\d{3}-\d{3}-\d{4}$/.test(this.value));
        });

        // Email validation (must contain "@" and ".")
        document.getElementById("email").addEventListener("input", function () {
            validateInput(this, /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(this.value));
        });

        document.addEventListener("DOMContentLoaded", function () {
            const imageUploadInput = document.getElementById("image-upload");
            const customUploadButton = document.getElementById("custom-upload-button");
            const dropArea = document.getElementById("drop-area");
            const imagePreviewContainer = document.getElementById("image-preview-container");
            const maxImages = 10;
            let imageFiles = [];

            customUploadButton.addEventListener("click", function () {
                imageUploadInput.click();
            });

            imageUploadInput.addEventListener("change", function () {
                handleFiles(imageUploadInput.files);
            });

            document.addEventListener("dragover", function (event) {
                event.preventDefault();
                dropArea.classList.add("bg-light");
            });

            document.addEventListener("dragleave", function () {
                dropArea.classList.remove("bg-light");
            });

            document.addEventListener("drop", function (event) {
                event.preventDefault();
                dropArea.classList.remove("bg-light");
                handleFiles(event.dataTransfer.files);
            });

            function handleFiles(files) {
                const fileArray = Array.from(files);
                if (imageFiles.length + fileArray.length > maxImages) {
                    alert(`You can only upload up to ${maxImages} images.`);
                    return;
                }

                fileArray.forEach(file => {
                    imageFiles.push(file);
                    displayImagePreview(file);
                });

                imageUploadInput.value = ""; // Clear the input

                // Hide the drag-and-drop area if there is at least one image
                if (imageFiles.length > 0) {
                    dropArea.style.display = "none";
                }
            }

            function displayImagePreview(file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const imagePreview = document.createElement("div");
                    imagePreview.classList.add("image-preview", "position-relative", "m-2");
                    imagePreview.style.width = "150px";
                    imagePreview.style.height = "150px";

                    const img = document.createElement("img");
                    img.src = e.target.result;
                    img.classList.add("img-thumbnail");
                    img.style.width = "100%";
                    img.style.height = "100%";
                    img.style.objectFit = "cover";

                    const removeButton = document.createElement("button");
                    removeButton.classList.add("btn", "btn-danger", "btn-sm", "position-absolute", "top-0", "end-0", "m-1");
                    removeButton.innerHTML = "&times;";
                    removeButton.addEventListener("click", function () {
                        imagePreview.remove();
                        imageFiles = imageFiles.filter(f => f !== file);

                        // Show the drag-and-drop area if there are no images
                        if (imageFiles.length === 0) {
                            dropArea.style.display = "block";
                        }
                    });

                    imagePreview.appendChild(img);
                    imagePreview.appendChild(removeButton);
                    imagePreviewContainer.appendChild(imagePreview);
                };
                reader.readAsDataURL(file);
            }

            // Prevent form submission on Enter key press CAUSING ISSUES WHEN USER PRESSES ENTER RANDOMLY
            document.getElementById("lease-form").addEventListener("keydown", function (event) {
                if (event.key === "Enter" && event.target.tagName !== "TEXTAREA") {
                    event.preventDefault();
                }
            });

            // Prevent form submission if fields are invalid
            document.getElementById("lease-form").addEventListener("submit", async function (event) {
                const inputs = document.querySelectorAll("input, select");
                let allValid = true;

                inputs.forEach(input => {
                    if (input.style.border === "2px solid red") {
                        allValid = false;
                    }
                });

                if (!allValid) {
                    event.preventDefault();
                    alert("Please correct invalid fields before submitting.");
                } else {
                    event.preventDefault();

                    const amenities = Array.from(document.querySelectorAll("input[type='checkbox']:checked")).map(cb => cb.id);

                    const leaseData = {
                        title: document.getElementById("title").value,
                        description: document.getElementById("comments").value,
                        price: document.getElementById("rent-price").value,
                        start_date: document.getElementById("start-date").value,
                        end_date: document.getElementById("end-date").value,
                        property_type: document.getElementById("property-type").value,
                        shared_space: document.getElementById("shared-space").value === "yes",
                        furnished: document.getElementById("furnished").value === "yes",
                        bathroom_type: document.getElementById("bathroom-type").value,
                        bedrooms: document.getElementById("bedrooms").value,
                        bathrooms: document.getElementById("bathrooms").value,
                        address: document.getElementById("address").value,
                        city: document.getElementById("city").value,
                        state: document.getElementById("state").value,
                        zip: document.getElementById("zip").value,
                        phone: document.getElementById("phone").value,
                        email: document.getElementById("email").value,
                        amenities: amenities
                    };

                    const formData = new FormData();
                    formData.append("leaseData", JSON.stringify(leaseData));

                    imageFiles.forEach(file => {
                        formData.append("images", file);
                    });

                    try {
                        const response = await fetch("/post-lease", {
                            method: "POST",
                            body: formData
                        });

                        const data = await response.json();
                        alert(data.message);
                        if (response.ok) {
                            window.location.href = "index.html";
                        }
                    } catch (error) {
                        console.error("Error posting lease:", error);
                        alert("An error occurred while posting the lease. Check console for details.");
                    }
                }
            });
        });

        async function loadNavbar() {
            const response = await fetch("navbar.html");
            const navbarHTML = await response.text();
            document.getElementById("navbar-placeholder").innerHTML = navbarHTML;
        }
        loadNavbar();

        async function checkSession() {
            try {
                const response = await fetch("/checkSession");
                if (response.ok) {
                    document.getElementById("auth-link").innerHTML =
                        `<li><a class="dropdown-item" href="javascript:void(0);" onclick="logout()">Logout</a></li>`;
                }
            } catch (error) {
                console.log("Not logged in");
            }
        }

        async function logout() {
            await fetch("/logout");
            alert("Logged out successfully!");
            window.location.reload();
        }

        checkSession();
    </script>
</body>
</html>