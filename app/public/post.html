<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Lease</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <nav>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="about.html">About Us</a></li>
            <li><a href="search.html">Search For Lease</a></li>
            <li><a href="post.html">Post Lease</a></li>
            <li id="auth-link"><a href="signup.html">Log In / Sign Up</a></li>
        </ul>
    </nav>

    <div class="center-container">
        <h2>Post Your Lease</h2><br>

        <!-- Lease Title -->
        <h4>Title Your Listing</h4>
        <input type="text" id="title" placeholder="Student Housing on 32nd and Spring Garden" required><br>

        <!-- Location Information -->
        <h4>Location</h4>
        <label for="address">Street Address:</label>
        <input type="text" id="address" placeholder="123 Main St" required>

        <label for="city">City:</label>
        <input type="text" id="city" placeholder="Enter city" required>

        <label for="state">State:</label>
        <input type="text" id="state" placeholder="Enter state" required>

        <label for="zip">Zip Code:</label>
        <input type="text" id="zip" placeholder="Enter zip code" required><br>

        <form id="lease-form">
            <!-- Lease Duration -->
            <h4>Lease Duration</h4>
            <label for="start-date">Start Date:</label>
            <input type="date" id="start-date" required><br>

            <label for="end-date">End Date:</label>
            <input type="date" id="end-date" required><br><br>

            <!-- Rent Price -->
            <h4>Rent Price</h4>
            <label for="rent-price">Rent per month ($):</label>
            <input type="number" id="rent-price" required><br><br>

            <!-- Property Details -->
            <h4>Property Details</h4>
            <label for="bedrooms">Number of Bedrooms:</label>
            <input type="number" id="bedrooms" required><br><br>

            <label for="bathrooms">Number of Bathrooms:</label>
            <input type="number" id="bathrooms" required><br><br>

            <label for="property-type">Property Type:</label>
            <select id="property-type" required>
                <option value="" disabled selected>Select</option>
                <option value="apartment">Apartment</option>
                <option value="house">House</option>
                <option value="student-housing">Student Housing</option>
                <option value="other">Other</option>
            </select><br><br>

            <label for="shared-space">Shared Space?</label>
            <select id="shared-space" required>
                <option value="" disabled selected>Select</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
            </select><br><br>

            <label for="furnished">Furnished?</label>
            <select id="furnished" required>
                <option value="" disabled selected>Select</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
            </select><br><br>

            <label for="bathroom-type">Private or Shared Bathroom?</label>
            <select id="bathroom-type" required>
                <option value="" disabled selected>Select</option>
                <option value="private">Private</option>
                <option value="shared">Shared</option>
            </select><br><br>

            <!-- Amenities -->
            <h4>Amenities</h4><br>
            <div class="amenities-container">

                <label class="amenity"><input type="checkbox" id="gym"> Gym</label>
                <label class="amenity"><input type="checkbox" id="pool"> Pool</label>
                <label class="amenity"><input type="checkbox" id="washer-dryer"> Washer/Dryer</label>
                <label class="amenity"><input type="checkbox" id="dishwasher"> Dishwasher</label>
                <label class="amenity"><input type="checkbox" id="tv"> TV</label>
                <label class="amenity"><input type="checkbox" id="full-kitchen"> Full Kitchen</label>
                <label class="amenity"><input type="checkbox" id="pet-friendly"> Pet Friendly</label>
                <label class="amenity"><input type="checkbox" id="free-parking"> Free Parking</label>
                <label class="amenity"><input type="checkbox" id="paid-parking"> Paid Parking</label>
                <label class="amenity"><input type="checkbox" id="remote-lock"> Remote Lock</label>
                <label class="amenity"><input type="checkbox" id="handicapped-access"> Handicapped Access</label>
            </div><br>

            <!-- Image Upload -->
            <h4>Upload Images</h4><br>
            <input type="file" id="images" name="images" accept="image/*" multiple><br><br>

            <!-- Additional Comments -->
            <h4>Additional Comments</h4><br>
            <textarea id="comments" rows="4" cols="50" placeholder="Enter extra details..."></textarea><br><br>

            <!-- Contact Information -->
            <h4>Contact Information</h4><br>
            <label for="phone">Phone Number:</label>
            <input type="tel" id="phone" placeholder="123-456-7890" required><br><br>

            <label for="email">Email Address:</label>
            <input type="email" id="email" placeholder="email@example.com" required><br><br>

            <!-- Submit Button -->
            <button type="submit">Submit Lease</button>
        </form>
    </div>

    <script>
        function validateInput(input, condition) {
            if (condition) {
                input.style.border = "2px solid green";
            } else {
                input.style.border = "2px solid red";
            }
        }

        // Title validation
        document.getElementById("title").addEventListener("input", function () {
            validateInput(this, this.value.trim().length > 0);
        });

        // Address validation
        document.getElementById("address").addEventListener("input", function () {
            validateInput(this, this.value.length >= 5);
        });

        // City & State validation (only letters)
        document.getElementById("city").addEventListener("input", function () {
            validateInput(this, /^[A-Za-z\s]+$/.test(this.value));
        });

        document.getElementById("state").addEventListener("input", function () {
            validateInput(this, /^[A-Za-z\s]+$/.test(this.value));
        });

        // Zip code validation (must be exactly 5 numbers)
        document.getElementById("zip").addEventListener("input", function () {
            validateInput(this, /^\d{5}$/.test(this.value));
        });

        // Date validation (Start date must be before end date)
        function validateDates() {
            const startDateInput = document.getElementById("start-date");
            const endDateInput = document.getElementById("end-date");

            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);

            if (!isNaN(startDate.getTime()) && !isNaN(endDate.getTime())) {
                if (startDate <= endDate) {
                    validateInput(startDateInput, true);
                    validateInput(endDateInput, true);
                } else {
                    validateInput(startDateInput, false);
                    validateInput(endDateInput, false);
                }
            } else {
                validateInput(startDateInput, !isNaN(startDate.getTime()));
                validateInput(endDateInput, !isNaN(endDate.getTime()));
            }
        }

        document.getElementById("start-date").addEventListener("input", validateDates);
        document.getElementById("end-date").addEventListener("input", validateDates);

        // Property details validation
        document.getElementById("rent-price").addEventListener("input", function () {
            validateInput(this, this.value >= 0);
        });

        document.getElementById("bedrooms").addEventListener("input", function () {
            validateInput(this, this.value > 0);
        });

        document.getElementById("bathrooms").addEventListener("input", function () {
            validateInput(this, this.value > 0);
        });

        // Phone number validation (format: 123-456-7890)
        document.getElementById("phone").addEventListener("input", function () {
            validateInput(this, /^\d{3}-\d{3}-\d{4}$/.test(this.value));
        });

        // Email validation (must contain "@" and ".")
        document.getElementById("email").addEventListener("input", function () {
            validateInput(this, /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(this.value));
        });

        // Prevent form submission if fields are invalid
        document.getElementById("lease-form").addEventListener("submit", async function (event) {
            const inputs = document.querySelectorAll("input, select");
            let allValid = true;

            inputs.forEach(input => {
                if (input.style.border === "2px solid red") {
                    allValid = false;
                }
            });

            if (!allValid) {
                event.preventDefault();
                alert("Please correct invalid fields before submitting.");
            } else {
                event.preventDefault();

                const amenities = Array.from(document.querySelectorAll("input[type='checkbox']:checked")).map(cb => cb.id);

                const leaseData = {
                    title: document.getElementById("title").value,
                    description: document.getElementById("comments").value,
                    price: document.getElementById("rent-price").value,
                    start_date: document.getElementById("start-date").value,
                    end_date: document.getElementById("end-date").value,
                    property_type: document.getElementById("property-type").value,
                    shared_space: document.getElementById("shared-space").value === "yes",
                    furnished: document.getElementById("furnished").value === "yes",
                    bathroom_type: document.getElementById("bathroom-type").value,
                    bedrooms: document.getElementById("bedrooms").value,
                    bathrooms: document.getElementById("bathrooms").value,
                    address: document.getElementById("address").value,
                    city: document.getElementById("city").value,
                    state: document.getElementById("state").value,
                    zip: document.getElementById("zip").value,
                    phone: document.getElementById("phone").value,
                    email: document.getElementById("email").value,
                    amenities: amenities
                };

                const formData = new FormData();
                formData.append("leaseData", JSON.stringify(leaseData));

                const imageFiles = document.getElementById("images").files;
                for (let i = 0; i < imageFiles.length; i++) {
                    formData.append("images", imageFiles[i]);
                }

                try {
                    const response = await fetch("/post-lease", {
                        method: "POST",
                        body: formData
                    });

                    const data = await response.json();
                    alert(data.message);
                    if (response.ok) {
                        window.location.href = "index.html";
                    }
                } catch (error) {
                    console.error("Error posting lease:", error);
                    alert("An error occurred while posting the lease. Check console for details.");
                }
            }
        });
        
        // Check if user is logged in on page load
        async function checkSession() {
            try {
                const response = await fetch("/checkSession");
                if (response.ok) {
                    document.getElementById("auth-link").innerHTML =
                        `<a href="javascript:void(0);" onclick="logout()">Logout</a>`;
                }
            } catch (error) {
                console.log("Not logged in");
            }
        }

        async function logout() {
            await fetch("/logout");
            alert("Logged out successfully!");
            window.location.reload();
        }

        checkSession();
    </script>
</body>

</html>